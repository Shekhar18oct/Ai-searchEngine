name: SonarQube Security and Quality Analysis

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarqube:
    name: SonarQube Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install coverage pytest-cov bandit pylint
      
      - name: Run tests with coverage
        run: |
          python -m pytest tests/ --cov=src --cov-report=xml:coverage.xml --cov-report=html
        continue-on-error: true
      
      - name: Run Bandit security scanner
        run: |
          bandit -r src -f json -o bandit-report.json
        continue-on-error: true
      
      - name: Run Pylint
        run: |
          pylint src --output-format=text > pylint-report.txt || true
        continue-on-error: true
      
      # SonarQube scanning (requires SONAR_TOKEN and SONAR_HOST_URL secrets)
      # Uncomment and configure secrets in GitHub repository settings to enable
      # - name: SonarQube Scan
      #   uses: sonarsource/sonarqube-scan-action@master
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #     SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      #   if: ${{ secrets.SONAR_TOKEN != '' }}
      # 
      # - name: SonarQube Quality Gate check
      #   id: sonarqube-quality-gate-check
      #   uses: sonarsource/sonarqube-quality-gate-action@master
      #   timeout-minutes: 5
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #     SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      #   continue-on-error: true
      #   if: ${{ secrets.SONAR_TOKEN != '' }}
      
      - name: Upload coverage reports (optional)
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage.xml
            htmlcov/
            bandit-report.json
            pylint-report.txt
        if: always()
